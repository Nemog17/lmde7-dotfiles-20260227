#!/usr/bin/env bash
set -uo pipefail

# ============================================================================
# setup-dev-env: Instala el entorno de desarrollo completo en cualquier Linux
# Herramientas: kitty, tmux, claude, yazi, lazygit, lazydocker + script "code"
# ============================================================================

# --- Colores ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

info()  { echo -e "${BLUE}[*]${NC} $1"; }
ok()    { echo -e "${GREEN}[+]${NC} $1"; }
warn()  { echo -e "${YELLOW}[!]${NC} $1"; }
fail()  { echo -e "${RED}[-]${NC} $1"; }

# --- Deteccion de arquitectura ---
detect_arch() {
    local arch
    arch="$(uname -m)"
    case "$arch" in
        x86_64)  echo "x86_64" ;;
        aarch64) echo "aarch64" ;;
        *)       fail "Arquitectura no soportada: $arch"; exit 1 ;;
    esac
}

ARCH="$(detect_arch)"
info "Arquitectura detectada: ${BOLD}$ARCH${NC}"

# --- Deteccion de package manager ---
detect_pkg_manager() {
    if command -v apt &>/dev/null; then
        echo "apt"
    elif command -v dnf &>/dev/null; then
        echo "dnf"
    elif command -v pacman &>/dev/null; then
        echo "pacman"
    elif command -v zypper &>/dev/null; then
        echo "zypper"
    else
        echo "unknown"
    fi
}

PKG_MGR="$(detect_pkg_manager)"
info "Package manager detectado: ${BOLD}$PKG_MGR${NC}"

# --- Directorio de binarios ---
mkdir -p "$HOME/.local/bin"

# --- Helper: obtener ultima version de un repo GitHub ---
gh_latest_version() {
    local repo="$1"
    local response
    response="$(curl -fsSL "https://api.github.com/repos/$repo/releases/latest")" || return 1
    echo "$response" | grep -Po '"tag_name": "v?\K[^"]*' || return 1
}

# --- Contadores para resumen final ---
declare -A RESULTS

# ============================================================================
# Paso 1: Dependencias del sistema (tmux, git, curl, unzip, tar)
# ============================================================================
echo ""
info "${BOLD}Paso 1/7: Dependencias del sistema${NC}"

install_system_deps() {
    local pkgs=(tmux git curl unzip tar)
    local to_install=()

    for pkg in "${pkgs[@]}"; do
        if ! command -v "$pkg" &>/dev/null; then
            to_install+=("$pkg")
        fi
    done

    if [[ ${#to_install[@]} -eq 0 ]]; then
        ok "Todas las dependencias del sistema ya estan instaladas"
        RESULTS[dependencias]="ok"
        return 0
    fi

    info "Instalando: ${to_install[*]}"

    case "$PKG_MGR" in
        apt)    sudo apt update -qq && sudo apt install -y -qq "${to_install[@]}" ;;
        dnf)    sudo dnf install -y -q "${to_install[@]}" ;;
        pacman) sudo pacman -S --noconfirm --needed "${to_install[@]}" ;;
        zypper) sudo zypper install -y "${to_install[@]}" ;;
        *)      fail "No se encontro package manager. Instala manualmente: ${to_install[*]}"
                RESULTS[dependencias]="fallo"
                return 1 ;;
    esac

    ok "Dependencias del sistema instaladas"
    RESULTS[dependencias]="ok"
}

install_system_deps

# ============================================================================
# Paso 2: Kitty terminal
# ============================================================================
echo ""
info "${BOLD}Paso 2/7: Kitty terminal${NC}"

install_kitty() {
    if command -v kitty &>/dev/null; then
        local ver
        ver="$(kitty --version 2>/dev/null | head -1)"
        warn "Kitty ya instalado: $ver"
        RESULTS[kitty]="ok (existente)"
        return 0
    fi

    info "Instalando kitty via installer oficial..."
    curl -fsSL https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin launch=n

    # Symlinks
    ln -sf "$HOME/.local/kitty.app/bin/kitty" "$HOME/.local/bin/kitty"
    ln -sf "$HOME/.local/kitty.app/bin/kitten" "$HOME/.local/bin/kitten"

    # Integracion desktop
    mkdir -p "$HOME/.local/share/applications"
    if [[ -f "$HOME/.local/kitty.app/share/applications/kitty.desktop" ]]; then
        cp "$HOME/.local/kitty.app/share/applications/kitty.desktop" "$HOME/.local/share/applications/"
        sed -i "s|Icon=kitty|Icon=$(readlink -f "$HOME")/.local/kitty.app/share/icons/hicolor/256x256/apps/kitty.png|g" \
            "$HOME/.local/share/applications/kitty.desktop"
        sed -i "s|Exec=kitty|Exec=$(readlink -f "$HOME")/.local/kitty.app/bin/kitty|g" \
            "$HOME/.local/share/applications/kitty.desktop"
    fi

    if "$HOME/.local/bin/kitty" --version &>/dev/null; then
        ok "Kitty instalado correctamente"
        RESULTS[kitty]="ok"
    else
        fail "Error instalando kitty"
        RESULTS[kitty]="fallo"
    fi
}

install_kitty

# ============================================================================
# Paso 3: Claude Code CLI
# ============================================================================
echo ""
info "${BOLD}Paso 3/7: Claude Code CLI${NC}"

install_claude() {
    if command -v claude &>/dev/null; then
        local ver
        ver="$(claude --version 2>/dev/null | head -1)"
        warn "Claude ya instalado: $ver"
        RESULTS[claude]="ok (existente)"
        return 0
    fi

    info "Instalando Claude Code via installer oficial..."
    curl -fsSL https://claude.ai/install.sh | bash

    if command -v claude &>/dev/null; then
        ok "Claude Code instalado correctamente"
        RESULTS[claude]="ok"
    else
        fail "Error instalando Claude Code"
        RESULTS[claude]="fallo"
    fi
}

install_claude

# ============================================================================
# Paso 4: Yazi (file manager TUI)
# ============================================================================
echo ""
info "${BOLD}Paso 4/7: Yazi${NC}"

install_yazi() {
    if command -v yazi &>/dev/null; then
        local ver
        ver="$(yazi --version 2>/dev/null | head -1)"
        warn "Yazi ya instalado: $ver"
        RESULTS[yazi]="ok (existente)"
        return 0
    fi

    local yazi_arch
    case "$ARCH" in
        x86_64)  yazi_arch="x86_64" ;;
        aarch64) yazi_arch="aarch64" ;;
        *) fail "Arquitectura no soportada para yazi: $ARCH"; RESULTS[yazi]="fallo"; return 1 ;;
    esac

    local url="https://github.com/sxyazi/yazi/releases/latest/download/yazi-${yazi_arch}-unknown-linux-gnu.zip"
    local tmp
    tmp="$(mktemp -d)"

    info "Descargando yazi..."
    if curl -fsSL "$url" -o "$tmp/yazi.zip"; then
        unzip -o -q "$tmp/yazi.zip" -d "$tmp"
        cp "$tmp"/yazi-*/yazi "$HOME/.local/bin/yazi"
        chmod +x "$HOME/.local/bin/yazi"
        ok "Yazi instalado correctamente"
        RESULTS[yazi]="ok"
    else
        fail "Error descargando yazi"
        RESULTS[yazi]="fallo"
    fi

    rm -rf "$tmp"
}

install_yazi

# ============================================================================
# Paso 5: Lazygit (Git TUI)
# ============================================================================
echo ""
info "${BOLD}Paso 5/7: Lazygit${NC}"

install_lazygit() {
    if command -v lazygit &>/dev/null; then
        local ver
        ver="$(lazygit --version 2>/dev/null | grep -oP 'version=\K[^,]*')"
        warn "Lazygit ya instalado: $ver"
        RESULTS[lazygit]="ok (existente)"
        return 0
    fi

    local lazygit_arch
    case "$ARCH" in
        x86_64)  lazygit_arch="x86_64" ;;
        aarch64) lazygit_arch="arm64" ;;
        *) fail "Arquitectura no soportada para lazygit: $ARCH"; RESULTS[lazygit]="fallo"; return 1 ;;
    esac

    local version
    version="$(gh_latest_version jesseduffield/lazygit)" || {
        fail "No se pudo obtener la version de lazygit"
        RESULTS[lazygit]="fallo"
        return 1
    }

    local url="https://github.com/jesseduffield/lazygit/releases/download/v${version}/lazygit_${version}_linux_${lazygit_arch}.tar.gz"
    local tmp
    tmp="$(mktemp -d)"

    info "Descargando lazygit v${version}..."
    if curl -fsSL "$url" -o "$tmp/lazygit.tar.gz"; then
        tar xzf "$tmp/lazygit.tar.gz" -C "$tmp" lazygit
        cp "$tmp/lazygit" "$HOME/.local/bin/lazygit"
        chmod +x "$HOME/.local/bin/lazygit"
        ok "Lazygit v${version} instalado correctamente"
        RESULTS[lazygit]="ok"
    else
        fail "Error descargando lazygit"
        RESULTS[lazygit]="fallo"
    fi

    rm -rf "$tmp"
}

install_lazygit

# ============================================================================
# Paso 6: Lazydocker (Docker TUI)
# ============================================================================
echo ""
info "${BOLD}Paso 6/7: Lazydocker${NC}"

install_lazydocker() {
    if command -v lazydocker &>/dev/null; then
        local ver
        ver="$(lazydocker --version 2>/dev/null | grep -oP 'Version: \K.*')"
        warn "Lazydocker ya instalado: $ver"
        RESULTS[lazydocker]="ok (existente)"
        return 0
    fi

    local ld_arch
    case "$ARCH" in
        x86_64)  ld_arch="x86_64" ;;
        aarch64) ld_arch="arm64" ;;
        *) fail "Arquitectura no soportada para lazydocker: $ARCH"; RESULTS[lazydocker]="fallo"; return 1 ;;
    esac

    local version
    version="$(gh_latest_version jesseduffield/lazydocker)" || {
        fail "No se pudo obtener la version de lazydocker"
        RESULTS[lazydocker]="fallo"
        return 1
    }

    local url="https://github.com/jesseduffield/lazydocker/releases/download/v${version}/lazydocker_${version}_Linux_${ld_arch}.tar.gz"
    local tmp
    tmp="$(mktemp -d)"

    info "Descargando lazydocker v${version}..."
    if curl -fsSL "$url" -o "$tmp/lazydocker.tar.gz"; then
        tar xzf "$tmp/lazydocker.tar.gz" -C "$tmp" lazydocker
        cp "$tmp/lazydocker" "$HOME/.local/bin/lazydocker"
        chmod +x "$HOME/.local/bin/lazydocker"
        ok "Lazydocker v${version} instalado correctamente"
        RESULTS[lazydocker]="ok"
    else
        fail "Error descargando lazydocker"
        RESULTS[lazydocker]="fallo"
    fi

    rm -rf "$tmp"
}

install_lazydocker

# ============================================================================
# Paso 7: PATH setup
# ============================================================================
echo ""
info "${BOLD}Paso 7/7: Configuracion de PATH${NC}"

setup_path() {
    local line='export PATH="$HOME/.local/bin:$PATH"'

    if grep -qF '.local/bin' "$HOME/.bashrc" 2>/dev/null; then
        warn "PATH ya configurado en .bashrc"
    else
        echo "" >> "$HOME/.bashrc"
        echo "# Dev environment PATH" >> "$HOME/.bashrc"
        echo "$line" >> "$HOME/.bashrc"
        ok "PATH agregado a .bashrc"
    fi

    # Tambien agregar a .zshrc si existe zsh
    if [[ -f "$HOME/.zshrc" ]]; then
        if grep -qF '.local/bin' "$HOME/.zshrc" 2>/dev/null; then
            warn "PATH ya configurado en .zshrc"
        else
            echo "" >> "$HOME/.zshrc"
            echo "# Dev environment PATH" >> "$HOME/.zshrc"
            echo "$line" >> "$HOME/.zshrc"
            ok "PATH agregado a .zshrc"
        fi
    fi

    RESULTS[path]="ok"
}

setup_path

# ============================================================================
# Resumen final
# ============================================================================
echo ""
echo -e "${BOLD}========================================${NC}"
echo -e "${BOLD}  Resumen de instalacion${NC}"
echo -e "${BOLD}========================================${NC}"

tools_order=(dependencias kitty claude yazi lazygit lazydocker path)
tool_labels=(
    "Dependencias (tmux, git, curl)"
    "Kitty terminal"
    "Claude Code CLI"
    "Yazi (file manager)"
    "Lazygit (Git TUI)"
    "Lazydocker (Docker TUI)"
    "PATH config"
)

all_ok=true
for i in "${!tools_order[@]}"; do
    local_key="${tools_order[$i]}"
    local_label="${tool_labels[$i]}"
    local_result="${RESULTS[$local_key]:-no ejecutado}"

    if [[ "$local_result" == *"ok"* ]]; then
        echo -e "  ${GREEN}+${NC} ${local_label}: ${GREEN}${local_result}${NC}"
    elif [[ "$local_result" == "fallo" ]]; then
        echo -e "  ${RED}x${NC} ${local_label}: ${RED}${local_result}${NC}"
        all_ok=false
    else
        echo -e "  ${YELLOW}?${NC} ${local_label}: ${YELLOW}${local_result}${NC}"
        all_ok=false
    fi
done

echo -e "${BOLD}========================================${NC}"

if $all_ok; then
    echo ""
    echo -e "${GREEN}${BOLD}Instalacion completa!${NC}"
    echo ""
    echo -e "  Abre una nueva terminal y ejecuta:"
    echo -e "    ${BOLD}code ~/tu-proyecto${NC}"
    echo ""
else
    echo ""
    echo -e "${YELLOW}Instalacion parcial. Revisa los errores arriba.${NC}"
fi
